#!/bin/bash

DNSPORT_TOR=5353
DNSPORT=53
NETWORK=10.192.0.0/10
TOR_PORT=9040

# Automatic add localhost as DNS
if [ ! -e /etc/resolv.orig ]; then
    cp -a /etc/resolv.conf /etc/resolv.orig
    sed -i 's/^nameserver/#nameserver/g' /etc/resolv.conf
    echo "nameserver 127.0.0.1" >> /etc/resolv.conf
else
    sed -i 's/^nameserver/#nameserver/g' /etc/resolv.conf
    echo "nameserver 127.0.0.1" >> /etc/resolv.conf
fi

# Flush IPTables
iptables -F
iptables -t nat -F

iptables -t nat -F OUTPUT
iptables -t nat -F PREROUTING
iptables -t nat -A PREROUTING -p udp --dport $DNSPORT -j REDIRECT --to-ports $DNSPORT_TOR
iptables -t nat -A PREROUTING -p tcp --syn -j REDIRECT --to-ports $TOR_PORT
iptables -t nat -A OUTPUT -m state --state ESTABLISHED -j RETURN
iptables -t nat -A OUTPUT -p udp --dport $DNSPORT -j REDIRECT --to-ports $DNSPORT_TOR
iptables -t nat -A OUTPUT -p tcp --dport $DNSPORT -j REDIRECT --to-ports $DNSPORT_TOR
iptables -t nat -A OUTPUT -d $NETWORK -p tcp -j REDIRECT --to-ports $TOR_PORT
iptables -t nat -A OUTPUT -d 127.0.0.1/8    -j RETURN
iptables -t nat -A OUTPUT -d 192.168.0.0/16 -j RETURN
iptables -t nat -A OUTPUT -d 172.16.0.0/12  -j RETURN
iptables -t nat -A OUTPUT -d 10.0.0.0/8     -j RETURN
iptables -t nat -A OUTPUT -p tcp -j REDIRECT --to-ports $TOR_PORT

iptables -t filter -F OUTPUT
iptables -t filter -A OUTPUT -m state --state ESTABLISHED -j ACCEPT
iptables -t filter -A OUTPUT -p udp --dport $DNSPORT_TOR -j ACCEPT
iptables -t filter -A OUTPUT -p tcp --dport $DNSPORT_TOR -j ACCEPT
iptables -t filter -A OUTPUT -d $NETWORK -p tcp -j ACCEPT
iptables -t filter -A OUTPUT -d 127.0.0.1/8    -j ACCEPT
iptables -t filter -A OUTPUT -d 192.168.0.0/16 -j ACCEPT
iptables -t filter -A OUTPUT -d 172.16.0.0/12  -j ACCEPT
iptables -t filter -A OUTPUT -d 10.0.0.0/8     -j ACCEPT
iptables -t filter -A OUTPUT -p tcp -j ACCEPT
iptables -t filter -A OUTPUT -p udp -j REJECT
iptables -t filter -A OUTPUT -p icmp -j REJECT
