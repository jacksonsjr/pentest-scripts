FROM golang:1.14-alpine3.11 AS builder

RUN apk update             \
    && apk upgrade --force \
    && apk add --no-cache git

RUN go get github.com/michenriksen/aquatone \
    && go build github.com/michenriksen/aquatone

RUN go get github.com/evilsocket/dnssearch \
    && go build github.com/evilsocket/dnssearch

RUN go get github.com/OJ/gobuster \
    && go build github.com/OJ/gobuster

RUN go get github.com/tomnomnom/httprobe \
    && go build github.com/tomnomnom/httprobe

RUN go get github.com/tomnomnom/waybackurls \
    && go build github.com/tomnomnom/waybackurls

ENV GOPATH /go
ENV GO111MODULE on
RUN go get -v -u github.com/OWASP/Amass/v3/... ; exit 0

FROM alpine:3.11

RUN apk update                    \
    && apk upgrade --force        \
    && apk add --no-cache         \
        bash                      \
        bind-tools                \
        chromium                  \
        curl                      \
        diffutils                 \
        jq                        \
        nmap                      \
        python3                   \
    && pip3 install --upgrade pip \
    && rm -rf /tmp/* /var/cache/apk/*

RUN apk add --no-cache git

RUN git clone https://github.com/maurosoria/dirsearch.git \
    /opt/dirsearch                                        \
    && ln -s /opt/dirsearch/dirsearch.py /usr/local/bin/dirsearch.py

RUN git clone https://github.com/darkoperator/dnsrecon.git        \
    /opt/dnsrecon                                                 \
    && ln -s /opt/dnsrecon/dnsrecon.py /usr/local/bin/dnsrecon.py \
    && apk update                                                 \
    && apk add --no-cache --virtual builder                       \
        build-base                                                \
        libxml2-dev                                               \
        libxslt-dev                                               \
        python3-dev                                               \
    && pip3 install -r /opt/dnsrecon/requirements.txt             \
    && apk del builder                                            \
    && rm -rf /tmp/* /var/cache/apk/*

RUN git clone https://github.com/aboul3la/Sublist3r.git              \
    /opt/Sublist3r                                                   \
    && ln -s /opt/Sublist3r/sublist3r.py /usr/local/bin/sublist3r.py \
    && pip3 install -r /opt/Sublist3r/requirements.txt               \
    && sed -i '1s/python/python3/' /opt/Sublist3r/sublist3r.py

RUN wget https://github.com/blechschmidt/massdns/archive/master.zip \
    && unzip master.zip -d /tmp/                                    \
    && apk update                                                   \
    && apk add --virtual builder                                    \
        build-base                                                  \
    && cd /tmp/massdns-master                                       \
    && make                                                         \
    && cp /tmp/massdns-master/bin/massdns /usr/local/bin            \
    && cp /tmp/massdns-master/scripts/*.py /usr/local/bin           \
    && sed -i '1s/python/python3/' /usr/local/bin/censys-extract.py \
    && sed -i '1s/python/python3/' /usr/local/bin/dnsparse.py       \
    && sed -i '1s/python/python3/' /usr/local/bin/ptr.py            \
    && sed -i '1s/python/python3/' /usr/local/bin/subbrute.py       \
    && apk del builder git                                          \
    && rm -rf /tmp/* /var/cache/apk/* /master.zip

COPY --from=builder /go/bin/aquatone /usr/local/bin/
COPY --from=builder /go/bin/amass /usr/local/bin/
COPY --from=builder /go/bin/dnssearch /usr/local/bin/
COPY --from=builder /go/bin/gobuster /usr/local/bin/
COPY --from=builder /go/bin/httprobe /usr/local/bin/
COPY --from=builder /go/bin/waybackurls /usr/local/bin/

COPY recon.sh /usr/local/bin/recon.sh

CMD [ "/usr/local/bin/recon.sh" ]
